# `terraform state`

## how to move some resources from one state to another - aka, state split

lets say we do have a pretty big terraform state, we wanna move some resources
to a new state directory

- create and initialize a new directory, with local file terraform state,
the main point here is to create "destination" `terraform.state` file
- if our source terraform state is remote, pull it, first - moving resources
between states is possible on local states only
    ```sh
    terraform state pull > terraform.state
    ```
- execute the move
    ```sh
    terraform state mv -state=terraform.tfstate -state-out=../new_dir/terraform.state module.vpc module.vpc
    ```
- execute plan and apply on `new_dir` - adjust `.tf` files accordingly
- execute plan and apply on `old_dir` - adjust `.tf` files accordingly
- push "old" terraform state back to remote
    ```sh
    terraform state push terraform.state
    ```

# `-plugin-dir`

We can pre-download needed plugins (providers and modules) to speed up `terraform init` phase (eg, if running in docker).
```
# first we create directory structure
/some/path/${REGISTRY_HOSTNAME}/${REGISTRY_NAMESPACE}/${PLUGIN_NAME}/${PLUGIN_VERSION}/${OS_ARCH}
# then we can execute terraform init with -plugin-dir option
terraform init -plugin-dir /some/path
```
Real life example:
```
export TERRAROFM_GRAFANA_PROVIDER_VERSION=1.28.2
wget https://releases.hashicorp.com/terraform-provider-grafana/${TERRAROFM_GRAFANA_PROVIDER_VERSION}/terraform-provider-grafana_${TERRAROFM_GRAFANA_PROVIDER_VERSION}_linux_amd64.zip -O terraform-provider-grafana.zip
mkdir -p /src/terraform/registry.terraform.io/grafana/grafana/${TERRAROFM_GRAFANA_PROVIDER_VERSION}/linux_amd64
unzip terraform-provider-grafana.zip -d /src/terraform/registry.terraform.io/grafana/grafana/${TERRAROFM_GRAFANA_PROVIDER_VERSION}/linux_amd64
rm -f terraform-provider-grafana.zip

terraform init -plugin-dir /src/terraform
```
